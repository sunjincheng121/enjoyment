<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/me.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/me.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/me.png?v=7.2.0">


  <link rel="mask-icon" href="/images/me.png?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":5},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Deep dive how to support Python UDF in Apache Flink 1.10Background在Apache Flink 1.9版中，我们引入了PyFlink模块，支持了Python Table API。Python用户可以完成数据转换和数据分析的作业。但是，您可能会发现在PyFlink 1.9中还不支持定义Python UDFs，对于想要扩展系统内置功能的P">
<meta name="keywords" content="Flink,PyFlink,UDF">
<meta property="og:type" content="article">
<meta property="og:title" content="Deep dive how to support Python UDF in Apache Flink 1.10">
<meta property="og:url" content="http://enjoyment.cool/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/index.html">
<meta property="og:site_name" content="Pretty Cool Enjoyment">
<meta property="og:description" content="Deep dive how to support Python UDF in Apache Flink 1.10Background在Apache Flink 1.9版中，我们引入了PyFlink模块，支持了Python Table API。Python用户可以完成数据转换和数据分析的作业。但是，您可能会发现在PyFlink 1.9中还不支持定义Python UDFs，对于想要扩展系统内置功能的P">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://enjoyment.cool/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818184369257.jpg">
<meta property="og:image" content="http://enjoyment.cool/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818192619897.jpg">
<meta property="og:image" content="http://enjoyment.cool/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818171550211.jpg">
<meta property="og:image" content="http://enjoyment.cool/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818220546821.jpg">
<meta property="og:image" content="http://enjoyment.cool/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818225341863.jpg">
<meta property="og:image" content="http://enjoyment.cool/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/pyflinkshell.gif">
<meta property="og:image" content="http://enjoyment.cool/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818277279537.jpg">
<meta property="og:image" content="http://enjoyment.cool/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818273381999.jpg">
<meta property="og:updated_time" content="2020-02-19T08:13:47.010Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Deep dive how to support Python UDF in Apache Flink 1.10">
<meta name="twitter:description" content="Deep dive how to support Python UDF in Apache Flink 1.10Background在Apache Flink 1.9版中，我们引入了PyFlink模块，支持了Python Table API。Python用户可以完成数据转换和数据分析的作业。但是，您可能会发现在PyFlink 1.9中还不支持定义Python UDFs，对于想要扩展系统内置功能的P">
<meta name="twitter:image" content="http://enjoyment.cool/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818184369257.jpg">





  
  
  <link rel="canonical" href="http://enjoyment.cool/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Deep dive how to support Python UDF in Apache Flink 1.10 | Pretty Cool Enjoyment</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Pretty Cool Enjoyment</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">Apache Flink</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-catalog">

    
    
      
    

    

    <a href="/catalog/" rel="section"><i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>Catalog</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/sunjincheng121" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://enjoyment.cool/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jincheng Sun">
      <meta itemprop="description" content="Apache Flink">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pretty Cool Enjoyment">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Deep dive how to support Python UDF in Apache Flink 1.10

              
            
          </h2>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-02-19 19:19:19 / Modified: 16:13:47" itemprop="dateCreated datePublished" datetime="2020-02-19T19:19:19+08:00">2020-02-19</time>
            </span>
          

          
            

            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/archives/Globalization/" itemprop="url" rel="index"><span itemprop="name">Globalization</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
                 Views:  
                <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
              </span>
            </span>
          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10"><a href="#Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10" class="headerlink" title="Deep dive how to support Python UDF in Apache Flink 1.10"></a>Deep dive how to support Python UDF in Apache Flink 1.10</h1><h1 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h1><p>在Apache Flink 1.9版中，我们引入了PyFlink模块，支持了Python Table API。Python用户可以完成数据转换和数据分析的作业。但是，您可能会发现在PyFlink 1.9中还不支持定义Python UDFs，对于想要扩展系统内置功能的Python用户来说，这可能诸多不便。</p>
<p>在刚刚发布的ApacheFlink 1.10中，PyFlink添加了对Python UDFs的支持。这意味着您可以从现在开始用Python编写UDF并扩展系统的功能。此外，本版本还支持Python UDF环境和依赖管理，因此您可以在UDF中使用第三方库，从而利用Python生态丰富的第三方库资源。</p>
<p>Apache Flink 1.9 introduced the Python Table API, allowing developers and data engineers to write Python Table API jobs for Table Transformations and Analysis, such as Python ETL or Aggregate jobs. However, Python users faced some limitations when it came to support for Python UDFs in Apache Flink 1.9, preventing them from extending the system’s built-in functionality. </p>
<p>In Apache Flink1.10, the community further extended the support for Python by adding Python UDFs in PyFlink. Additionally, both the Python UDF Environment and Dependency Management are now supported, allowing users to import third-party libraries in the UDFs, leveraging Python’s rich set of third-party libraries. </p>
<h1 id="Architecture-of-Python-UDFs-supports-in-Pyflink"><a href="#Architecture-of-Python-UDFs-supports-in-Pyflink" class="headerlink" title="Architecture of Python UDFs supports in Pyflink"></a>Architecture of Python UDFs supports in Pyflink</h1><p>在深入了解如何定义和使用Python UDFs之前，我们将解释UDFs在PyFlink中工作的架构和背景，并提供一些有关我们底层实现的细节介绍。</p>
<p>Before diving into how you can define and use Python UDFs, we explain the architecture and background behind how UDFs work in PyFlink and provide some additional context about the implementation of our approach.</p>
<h2 id="Beam-on-Flink"><a href="#Beam-on-Flink" class="headerlink" title="Beam on Flink"></a>Beam on Flink</h2><p>Apache Beam是一个统一编程模型框架，实现了可使用任何语言开发可以运行在任何执行引擎上的批处理和流处理作业，这得益于Beam的Portability Framework，如下图所示：</p>
<p>Apache Beam is an advanced unified programming model implement batch and streaming data processing jobs that run on any execution engine and any languages.This benefits from the Beam Portability Framework, as shown in the following figure:</p>
<p><img src="/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818184369257.jpg" alt><br>                Figure 1: Portability Framework</p>
<p>上图是Beam的 Portability Framework 的体系结构。 它描述了Beam如何支持多种语言和多种引擎的方式。 关于Flink Runner部分，我们可以说是Beam on Flink。 那么，这与PyFlink支持Python UDF有什么关系呢？ 这将接下来“Flink on Beam” 中介绍。</p>
<p>The above figure is the architecture of the Beam Portability Framework. It describes how the Beam supports multiple languages and multiple runners. Regarding Flink Runner, we can say that it is Beam on Flink. So what does this have to do with Python UDFs supports in PyFlink? This is covered in the next Flink on Beam section.</p>
<h2 id="Flink-on-Beam"><a href="#Flink-on-Beam" class="headerlink" title="Flink on Beam"></a>Flink on Beam</h2><p>Apache Flink是一个开源项目，因此，它的社区也更多地使用开源。 例如，PyFlink中对Python UDF的支持选择了基于Apache Beam这辆豪华跑车之上进行构建。:)</p>
<p>Apache Flink is an open source project, so, its community also more embraces open source. Such as, Python UDFs support in PyFlink chose to build based on Apache Beam(A luxury sports car ). :)</p>
<p> <img src="/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818192619897.jpg" alt><br>             Figure 2: Flink on Beam</p>
<p>PyFlink对Python UDFs的支持上，Python的运行环境管理以及Python运行环境Python VM和Java运行环境JVM的通讯至关重要。幸运的是，Apache Beam的Portability Framework完美解决了这个问题。所以才有了如下PyFlink on Beam Portability Framework的架构如下：</p>
<p>In PyFlink’s support for Python UDFs, the management of the Python runtime environment and the communication between the Python runtime environment Python VM and the Java runtime environment JVM are critical. Fortunately, Apache Beam’s Portability Framework solves this problem perfectly. Therefore, we have the following architecture: PyFlink on Beam Portability Framework.</p>
<p><img src="/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818171550211.jpg" alt><br>    Figure 3: PyFlink on Beam Portability Framework</p>
<p>Beam Portability Framework 是一个成熟的多语言支持框架，框架高度抽象了语言之间的通信协议(gRPC),定义了数据的传输格式(Protobuf)，并且根据通用流计算框架所需要的组件，抽象个各种服务，比如, DataService，StateService，MetricsService等。在这样一个成熟的框架下，PyFlink可以快速的构建自己的Python算子，同时重用Apache Beam Portability Framework中现有SDK harness组件，可以支持多种Python运行模式，如：Process，Docker，etc.，这使得PyFlink对Python UDF的支持变得非常容易，在Apache Flink 1.10中的功能也非常的稳定和完整。那么为啥说是Apache Flink和Apache Beam 共同打造呢，是因为我发现目前Apache Beam Portability Framework的框架也存在很多优化的空间，所以我在Beam社区进行了<a href="https://lists.apache.org/thread.html/4025a19ba267f0b1b842af20b63ac794306259a3226e07c87bda62ba@%3Cdev.beam.apache.org%3E" target="_blank" rel="noopener">优化讨论</a>，并且在Beam 社区也贡献了30+的<a href="https://github.com/apache/beam/commits?author=sunjincheng121" target="_blank" rel="noopener">优化补丁</a>。</p>
<p>Beam Portability Framework is a mature multi-language support framework. The framework highly abstracts the communication protocol between languages (gRPC), defines the data transmission format (Protobuf), and abstracts each component according to the components required by the general stream computing framework services, such as,  DataService, StateService, MetricsService, etc. Under such a mature framework, PyFlink can quickly build its own Python operators, while reusing the existing SDK harness components in the Apache Beam Portability Framework, and can support multiple Python operating modes, such as: Process, Docker, etc., which It makes PyFlink support for Python UDF very easy, and the features in Apache Flink 1.10 are also very stable and complete. So why did it say that Apache Flink and Apache Beam were jointly built? Because there is still a lot of work for optimization in the current Apache Beam Portability Framework framework, so I conducted optimization <a href="https://lists.apache.org/thread.html/4025a19ba267f0b1b842af20b63ac794306259a3226e07c87bda62ba@%3Cdev.beam.apache.org%3E" target="_blank" rel="noopener">discussions</a> in the Beam community, and contributed to the Beam community 30+ optimized <a href="https://github.com/apache/beam/commits?author=sunjincheng121" target="_blank" rel="noopener">patches</a>.</p>
<h2 id="Communication-between-JVM-and-Python-VM"><a href="#Communication-between-JVM-and-Python-VM" class="headerlink" title="Communication between JVM and Python VM"></a>Communication between JVM and Python VM</h2><p>由于Python UDF无法直接在JVM中运行，因此需要由Apache Flink算子在初始化时启动的Python进程来准备Python执行环境。 Python ENV服务负责启动，管理和终止Python进程。 如下图4所示，Apache Flink算子和Python执行环境之间的通信和涉及多个组件：</p>
<p>Since Python UDFs cannot directly run in JVM, they are executed within the Python environment, in a Python Process initiated by the Apache Flink operator upon initialization. The Python environment is responsible for launching, managing and tearing down the Python Process. As illustrated in Figure 4 below, several components are involved in the communication between the Apache Flink operator and the Python execution environment:</p>
<p><img src="/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818220546821.jpg" alt><br>    Figure 4: Communication between JVM and Python VM</p>
<ul>
<li>环境管理服务: 负责启动和终止Python执行环境。</li>
<li>数据服务: 负责在Apache Flink算子和Python执行环境之间传输输入数据和接收用户UDF的执行结果。</li>
<li>日志服务: 是记录对用户UDF日志输出支持的机制。 它可以将用户UDF产生的日志传输到Apache Flink算子，并与Apache Flink的日志系统集成。 </li>
</ul>
<p>说明: 其中 metrics 服务 计划在 Apache Flink 1.11 进行支持。</p>
<ul>
<li>Environment Service: Responsible for launching and destroying the Python execution environment. </li>
<li>Data Service: Responsible for transferring the input data and the user-defined function execution results between the Apache Flink operator and the Python execution environment.</li>
<li>Logging Service: Mechanism for logging support for user defined functions. It allows transferring log entries produced by user defined functions to the Apache Flink operator and integrates with Apache Flink’s own logging system. </li>
</ul>
<p>NOTE: Supporting metrics is currently planned for Apache Flink 1.11.</p>
<p>图5 描述了从Java 算子到Python进程之间初始化和执行UDF的概要流程。</p>
<p>Figure 5 below describes the high-level flow between initializing and executing UDFs from the Java operator to the Python process. </p>
<p><img src="/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818225341863.jpg" alt><br>    Figure 5: High-level flow between Python VM and JVM<br>流程可以概括为如下两部分：</p>
<ul>
<li>初始化Python执行环境。<ul>
<li>Python UDF Runner启动所需的gRPC服务，如数据服务、日志服务等。</li>
<li>Python UDF Runner另起进程并启动Python执行环境。</li>
<li>Python worker向PythonUserDefinedFunctionRunner进行注册。</li>
<li>Python UDF Runner向Python worker发送需要在Python进程中执行的用户定义函数。</li>
<li>Python worker将用户定义的函数转换为Beam 执行算子（注意：目前，PyFlink利用Beam的可移植性框架[1]来执行Python UDF）。</li>
<li>Python worker和Flink Operator之间建立gRPC连接，如数据连接、日志连接等。</li>
</ul>
</li>
<li>处理输入元素。<ul>
<li>Python UDF Runner通过gRPC数据服务将输入元素发送给Python worker执行。</li>
<li>Python用户定义函数还可以在执行期间通过gRPC日志服务和metrics服务将日志和metrics收集到Python UDF Runner。</li>
<li>执行结果可以通过gRPC数据服务发送到Python UDF Runner。</li>
</ul>
</li>
</ul>
<p>The high-level flow can be summarized in two parts:</p>
<ul>
<li><p>Initialization of the Python execution environment.</p>
<ul>
<li>The Python UDF Runner starts the gRPC services, such as the data service, logging service, etc.</li>
<li>The Python UDF Runner launches the Python execution environment in a separate process.</li>
<li>The Python worker registers to PythonUserDefinedFunctionRunner.</li>
<li>The Python UDF Runner sends the user defined functions to be executed in the Python worker.</li>
<li>The Python worker transforms the user defined functions to Beam operations. (Note that we leverage the power of Beam’s <a href="https://beam.apache.org/roadmap/portability/" target="_blank" rel="noopener">Portability Framework</a> to execute the Python UDF.)</li>
<li>The Python worker establishes the gRPC connections, such as the data connection, logging connection, etc.</li>
</ul>
</li>
<li><p>Processing of the input elements.</p>
<ul>
<li>The Python UDF Runner sends the input elements via the gRPC data service to the Python worker for execution.</li>
<li>The Python use defined function can access the state via gRPC state service during execution.</li>
<li>The Python user defined function can also aggregate the logging and metrics to the Python UDF Runner via the gRPC logging service and the metrics service during execution.</li>
<li>The execution results are finally sent to the Python UDF Runner via the gRPC data service.</li>
</ul>
</li>
</ul>
<h1 id="How-to-use-PyFlink-with-UDFs-in-Apache-Flink-1-10"><a href="#How-to-use-PyFlink-with-UDFs-in-Apache-Flink-1-10" class="headerlink" title="How to use PyFlink with UDFs in Apache Flink 1.10"></a>How to use PyFlink with UDFs in Apache Flink 1.10</h1><p>本节将介绍用户如何定义UDF，并完整展示了如何安装PyFlink，如何在PyFlink中定义/注册/调用UDF，以及如何执行作业。</p>
<p>This section provides some Python user defined function (UDF) examples, Including how to install PyFlink, how to define/register/invoke UDFs in PyFlink and how to execute the job.</p>
<h2 id="Install-PyFlink"><a href="#Install-PyFlink" class="headerlink" title="Install PyFlink"></a>Install PyFlink</h2><p>我们需要先安装PyFlink，可以通过PyPI获得，并且可以使用<code>pip install</code>进行便捷安装。</p>
<p>注意: 安装和运行PyFlink需要Python 3.5或更高版本。</p>
<p>Using Python in Apache Apache Flink requires installing PyFlink. PyFlink is available through PyPi and can be easily installed using pip: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python -m pip install apache-Apache Flink</span><br></pre></td></tr></table></figure>

<p>Please note that Python 3.5 or higher is required to install and run PyFlink.</p>
<h2 id="Define-a-Python-UDF"><a href="#Define-a-Python-UDF" class="headerlink" title="Define a Python UDF"></a>Define a Python UDF</h2><p>除了扩展基类ScalarFunction之外，定义Python UDF的方法有很多。下面的示例显示了定义Python UDF的不同方法，该函数以<code>BIGINT</code>类型的两列作为输入参数，并返回它们的和作为结果。</p>
<p>There are many ways to define a Python scalar function, besides extending the base class ScalarFunction. The following example shows the different ways of defining a Python scalar function that takes two columns of BIGINT as input parameters and returns the sum of them as the result.</p>
<ul>
<li>Option 1: extending the base class <code>ScalarFunction</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class Add(ScalarFunction):</span><br><span class="line">  def eval(self, i, j):</span><br><span class="line">    return i + j</span><br><span class="line"></span><br><span class="line">add = udf(Add(), [DataTypes.BIGINT(), DataTypes.BIGINT()], DataTypes.BIGINT())</span><br></pre></td></tr></table></figure>

<ul>
<li>Option 2: Python function</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@udf(input_types=[DataTypes.BIGINT(), DataTypes.BIGINT()], result_type=DataTypes.BIGINT())</span><br><span class="line">def add(i, j):</span><br><span class="line">  return i + j</span><br></pre></td></tr></table></figure>

<ul>
<li>option 3: lambda function</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add = udf(lambda i, j: i + j, [DataTypes.BIGINT(), DataTypes.BIGINT()], DataTypes.BIGINT())</span><br></pre></td></tr></table></figure>

<ul>
<li>option 4: callable function</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class CallableAdd(object):</span><br><span class="line">  def __call__(self, i, j):</span><br><span class="line">    return i + j</span><br><span class="line"></span><br><span class="line">add = udf(CallableAdd(), [DataTypes.BIGINT(), DataTypes.BIGINT()], DataTypes.BIGINT())</span><br></pre></td></tr></table></figure>

<ul>
<li>option 5: partial function</li>
</ul>
<figure class="highlight plain"><figcaption><span>partial_add(i, j, k):</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  return i + j + k</span><br><span class="line"></span><br><span class="line">add = udf(functools.partial(partial_add, k=1), [DataTypes.BIGINT(), DataTypes.BIGINT()],</span><br><span class="line">          DataTypes.BIGINT())</span><br></pre></td></tr></table></figure>

<h2 id="Register-a-Python-UDF"><a href="#Register-a-Python-UDF" class="headerlink" title="Register a Python UDF"></a>Register a Python UDF</h2><ul>
<li>register the Python function</li>
</ul>
<p><code>table_env.register_function(&quot;add&quot;, add)</code></p>
<ul>
<li>Invoke a Python UDF</li>
</ul>
<p><code>my_table.select(&quot;add(a, b)&quot;)</code></p>
<ul>
<li>Example Code</li>
</ul>
<p>下面是一个使用Python UDF的完整示例。<br>Below, you can find a complete example of using Python UDF.</p>
<figure class="highlight plain"><figcaption><span>PyFlink.datastream import StreamExecutionEnvironment</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">from PyFlink.table import StreamTableEnvironment, DataTypes</span><br><span class="line">from PyFlink.table.descriptors import Schema, OldCsv, FileSystem</span><br><span class="line">from PyFlink.table.udf import udf</span><br><span class="line"></span><br><span class="line">env = StreamExecutionEnvironment.get_execution_environment()</span><br><span class="line">env.set_parallelism(1)</span><br><span class="line">t_env = StreamTableEnvironment.create(env)</span><br><span class="line"></span><br><span class="line">t_env.register_function(&quot;add&quot;, udf(lambda i, j: i + j, [DataTypes.BIGINT(), DataTypes.BIGINT()], DataTypes.BIGINT()))</span><br><span class="line"></span><br><span class="line">t_env.connect(FileSystem().path(&apos;/tmp/input&apos;)) \</span><br><span class="line">    .with_format(OldCsv()</span><br><span class="line">                 .field(&apos;a&apos;, DataTypes.BIGINT())</span><br><span class="line">                 .field(&apos;b&apos;, DataTypes.BIGINT())) \</span><br><span class="line">    .with_schema(Schema()</span><br><span class="line">                 .field(&apos;a&apos;, DataTypes.BIGINT())</span><br><span class="line">                 .field(&apos;b&apos;, DataTypes.BIGINT())) \</span><br><span class="line">    .create_temporary_table(&apos;mySource&apos;)</span><br><span class="line"></span><br><span class="line">t_env.connect(FileSystem().path(&apos;/tmp/output&apos;)) \</span><br><span class="line">    .with_format(OldCsv()</span><br><span class="line">                 .field(&apos;sum&apos;, DataTypes.BIGINT())) \</span><br><span class="line">    .with_schema(Schema()</span><br><span class="line">                 .field(&apos;sum&apos;, DataTypes.BIGINT())) \</span><br><span class="line">    .create_temporary_table(&apos;mySink&apos;)</span><br><span class="line"></span><br><span class="line">t_env.from_path(&apos;mySource&apos;)\</span><br><span class="line">    .select(&quot;add(a, b)&quot;) \</span><br><span class="line">    .insert_into(&apos;mySink&apos;)</span><br><span class="line"></span><br><span class="line">t_env.execute(&quot;tutorial_job&quot;)</span><br></pre></td></tr></table></figure>

<ul>
<li>Submit the job</li>
</ul>
<p>Firstly, you need to prepare the input data in the “/tmp/input” file. For example,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;1,2&quot; &gt; /tmp/input</span><br></pre></td></tr></table></figure>

<p>Next, you can run this example on the command line,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python python_udf_sum.py</span><br></pre></td></tr></table></figure>

<p>The command builds and runs the Python Table API program in a local mini-cluster. You can also submit the Python Table API program to a remote cluster using different command lines, (see more details <a href="https://ci.apache.org/projects/flink/flink-docs-master/ops/cli.html#job-submission-examples" target="_blank" rel="noopener">here</a>).</p>
<p>Finally, you can see the execution result on the command line:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /tmp/output</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<h1 id="Python-UDF-dependency-management"><a href="#Python-UDF-dependency-management" class="headerlink" title="Python UDF dependency management"></a>Python UDF dependency management</h1><p>在许多情况下，您可能希望在Python UDF中导入第三方依赖。下面的示例将指导您如何管理依赖项。</p>
<p>In many cases, you would like to import third-party dependencies in the Python UDF. The example below provides detailed guidance on how to manage such dependencies.</p>
<p>假设您想使用mpmath来执行上述示例中两数的和。Python UDF逻辑可能如下：<br>Suppose you want to use the <code>mpmath</code> to perform the sum of the example above. The Python UDF may look like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@udf(input_types=[DataTypes.BIGINT(), DataTypes.BIGINT()], result_type=DataTypes.BIGINT())</span><br><span class="line">def add(i, j):</span><br><span class="line">    from mpmath import fadd # add third-party dependency</span><br><span class="line">    return int(fadd(1, 2))</span><br></pre></td></tr></table></figure>

<p>要使其在不包含依赖项的工作节点上运行，可以使用以下API指定依赖项：</p>
<p>To make it available on the worker node that does not contain the dependency, you can specify the dependencies with the following API:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># echo mpmath==1.1.0 &gt; requirements.txt</span><br><span class="line"># pip download -d cached_dir -r requirements.txt --no-binary :all:</span><br><span class="line">t_env.set_python_requirements(&quot;/path/of/requirements.txt&quot;, &quot;/path/of/cached_dir&quot;)</span><br></pre></td></tr></table></figure>

<p>用户需要提供一个requirements.txt文件，并且在里面申明使用的第三方依赖。如果无法在群集中安装依赖项（网络问题），则可以使用参数“requirements_cached_dir”，指定包含这些依赖项的安装包的目录，如上面的示例所示。依赖项将上传到群集并脱机安装。</p>
<p>A requirements.txt file that defines the third-party dependencies is used. If the dependencies cannot be accessed in the cluster, then you can specify a directory containing the installation packages of these dependencies by using the parameter “requirements_cached_dir”, as illustrated in the example above. The dependencies will be uploaded to the cluster and installed offline. </p>
<p>下面是一个使用依赖管理的完整示例：</p>
<p>Below, we showcase a complete example of using dependency management for Python UDFs in Apache Flink 1.10：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">from PyFlink.datastream import StreamExecutionEnvironment</span><br><span class="line">from PyFlink.table import StreamTableEnvironment, DataTypes</span><br><span class="line">from PyFlink.table.descriptors import Schema, OldCsv, FileSystem</span><br><span class="line">from PyFlink.table.udf import udf</span><br><span class="line"></span><br><span class="line">env = StreamExecutionEnvironment.get_execution_environment()</span><br><span class="line">env.set_parallelism(1)</span><br><span class="line">t_env = StreamTableEnvironment.create(env)</span><br><span class="line"></span><br><span class="line">@udf(input_types=[DataTypes.BIGINT(), DataTypes.BIGINT()], result_type=DataTypes.BIGINT())</span><br><span class="line">def add(i, j):</span><br><span class="line">    from mpmath import fadd</span><br><span class="line">    return int(fadd(1, 2))</span><br><span class="line"></span><br><span class="line">t_env.set_python_requirements(&quot;/tmp/requirements.txt&quot;, &quot;/tmp/cached_dir&quot;)</span><br><span class="line">t_env.register_function(&quot;add&quot;, add)</span><br><span class="line"></span><br><span class="line">t_env.connect(FileSystem().path(&apos;/tmp/input&apos;)) \</span><br><span class="line">    .with_format(OldCsv()</span><br><span class="line">                 .field(&apos;a&apos;, DataTypes.BIGINT())</span><br><span class="line">                 .field(&apos;b&apos;, DataTypes.BIGINT())) \</span><br><span class="line">    .with_schema(Schema()</span><br><span class="line">                 .field(&apos;a&apos;, DataTypes.BIGINT())</span><br><span class="line">                 .field(&apos;b&apos;, DataTypes.BIGINT())) \</span><br><span class="line">    .create_temporary_table(&apos;mySource&apos;)</span><br><span class="line"></span><br><span class="line">t_env.connect(FileSystem().path(&apos;/tmp/output&apos;)) \</span><br><span class="line">    .with_format(OldCsv()</span><br><span class="line">                 .field(&apos;sum&apos;, DataTypes.BIGINT())) \</span><br><span class="line">    .with_schema(Schema()</span><br><span class="line">                 .field(&apos;sum&apos;, DataTypes.BIGINT())) \</span><br><span class="line">    .create_temporary_table(&apos;mySink&apos;)</span><br><span class="line"></span><br><span class="line">t_env.from_path(&apos;mySource&apos;)\</span><br><span class="line">    .select(&quot;add(a, b)&quot;) \</span><br><span class="line">    .insert_into(&apos;mySink&apos;)</span><br><span class="line"></span><br><span class="line">t_env.execute(&quot;tutorial_job&quot;)</span><br></pre></td></tr></table></figure>

<p>Submit the job</p>
<p>Firstly, you need to prepare input data in the “/tmp/input” file. For example,</p>
<figure class="highlight plain"><figcaption><span>echo "1,2" ></span><a href="/tmp/input">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Secondly, you can prepare the dependency requirements file and the cache dir,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;mpmath==1.1.0&quot; &gt; /tmp/requirements.txt</span><br><span class="line">$ pip download -d /tmp/cached_dir -r /tmp/requirements.txt --no-binary :all:</span><br></pre></td></tr></table></figure>

<p>Next, you can run this example on the command line,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python python_udf_sum.py</span><br></pre></td></tr></table></figure>

<p>Finally, you can see the execution result on the command line:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /tmp/output</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<h1 id="Quick-start"><a href="#Quick-start" class="headerlink" title="Quick start"></a>Quick start</h1><p>PyFlink为大家提供了一种非常方便的开发体验方式 - PyFlink Shell。当成功执行 <code>python -m pip install apache-flink</code>之后，你可以直接以<code>pyflink-shell.sh local</code>来启动一个PyFlink Shell进行开发体验，如下所示：</p>
<p>Pyflink provides a very convenient way to development - pyflink shell. After successfully executing <code>python -m pip install apache-flink</code>, you can directly start a pyflink shell with <code>pyflink-shell.sh local</code> as shown below:</p>
<p><img src="/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/pyflinkshell.gif" alt></p>
<h1 id="More"><a href="#More" class="headerlink" title="More"></a>More</h1><p>不仅仅是简单的ETL场景支持，PyFlink可以完成很多复杂场的业务场景需求，比如我们最熟悉的双11大屏的场景，如下：</p>
<p>Not only simple ETL scenario support, PyFlink can fulfill the  requirements of many complex business scenario, such as the double 11 large screen scenario that we are most familiar with, as follows:</p>
<p><img src="/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818277279537.jpg" alt></p>
<p>关于上面示例的更多详细请查阅 <a href="https://enjoyment.cool/2019/12/05/Apache-Flink-%E8%AF%B4%E9%81%93%E7%B3%BB%E5%88%97-%E5%A6%82%E4%BD%95%E5%9C%A8PyFlink-1-10%E4%B8%AD%E8%87%AA%E5%AE%9A%E4%B9%89Python-UDF/">这里</a>。<br>More detail about above example can be found <a href="https://enjoyment.cool/2019/12/05/Apache-Flink-%E8%AF%B4%E9%81%93%E7%B3%BB%E5%88%97-%E5%A6%82%E4%BD%95%E5%9C%A8PyFlink-1-10%E4%B8%AD%E8%87%AA%E5%AE%9A%E4%B9%89Python-UDF/">here</a>.</p>
<h1 id="Conclusion-amp-Upcoming-work"><a href="#Conclusion-amp-Upcoming-work" class="headerlink" title="Conclusion &amp; Upcoming work"></a>Conclusion &amp; Upcoming work</h1><p>在本博客中，我们介绍了PyFlink中Python UDF的架构，并给出了如何定义、注册、调用和运行UDF的示例。随着1.10的发布，它将为Python用户提供更多的可能来编写Python作业逻辑。同时，我们一直积极与社区合作，不断改进PyFlink的功能和性能。今后，我们计划在标量和聚合函数中引入对Pandas的支持；通过SQL客户端增加对Python UDF使用的支持，以扩展Python UDF的使用范围；并做更多的性能改进。近期，邮件列表上有一个关于新功能支持的<a href="http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/DISCUSS-What-parts-of-the-Python-API-should-we-focus-on-next-td31731.html" target="_blank" rel="noopener">讨论</a>，您可以查看并找到更多详细信息。</p>
<p>In this blog post, we introduced the architecture of Python UDFs in PyFlink and provided some examples on how to define, register and invoke UDFs. Apache Flink 1.10 brings Python support in the framework to new levels, allowing Python users to write even more magic with their preferred language. The community is actively working towards continuously improving the functionality and performance of PyFlink. Future work in upcoming releases will introduce support for Pandas UDFs in scalar and aggregate functions, add support to use Python UDFs through the SQL client to further expand the usage scope of Python UDFs and finally work towards even more performance improvements. To find more information about the upcoming work with Python in Apache Apache Flink you can join the <a href="http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/DISCUSS-What-parts-of-the-Python-API-should-we-focus-on-next-td31731.html" target="_blank" rel="noopener">discussion</a> on the Apache Apache Flink mailing and share your suggestions and thoughts with the community.</p>
<p>在社区贡献者的不断努力之下，PyFlink的功能可以如上图一样可以迅速从幼苗变成大树:</p>
<p>With the continuous efforts of community contributors, PyFlink can quickly change from seedlings to trees as shown in the follows figure:</p>
<p><img src="/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/15818273381999.jpg" alt></p>
<h1 id="PyFlink-Want-You"><a href="#PyFlink-Want-You" class="headerlink" title="PyFlink Want You"></a>PyFlink Want You</h1><p>PyFlink是一个新组件，仍然需要做很多工作。 因此，热诚欢迎每个人加入对PyFlink的贡献，包括提出问题，提交错误报告，提出新功能，加入讨论，贡献代码或文档。。。期望在PyFlink见到你！</p>
<p>PyFlink is a new component and still needs a lot of work. Therefore, we sincerely welcome everyone to join our contribution to PyFlink, including asking questions, submitting error reports, proposing new functions, joining discussions, contributing codes or documents…</p>
<p>Hope to see you in PyFlink!</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        
          
        
        <div class="post-tags">
          
            <a href="/archives/Flink/" rel="tag"># Flink</a>
          
            <a href="/archives/PyFlink/" rel="tag"># PyFlink</a>
          
            <a href="/archives/UDF/" rel="tag"># UDF</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/01/22/Three-Min-Series-How-PyFlink-does-ETL/" rel="next" title="Three Min Series - How PyFlink does ETL">
                <i class="fa fa-chevron-left"></i> Three Min Series - How PyFlink does ETL
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/02/22/Three-Min-Series-How-to-using-PyFlink-Shell/" rel="prev" title="Three Min Series - How to using PyFlink Shell">
                Three Min Series - How to using PyFlink Shell <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Jincheng Sun">
            
              <p class="site-author-name" itemprop="name">Jincheng Sun</p>
              <div class="site-description motion-element" itemprop="description">Apache Flink</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">36</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/sunjincheng121/enjoyment" title="GitHub &rarr; https://github.com/sunjincheng121/enjoyment" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://twitter.com/sunjincheng121" title="Twitter &rarr; https://twitter.com/sunjincheng121" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10"><span class="nav-number">1.</span> <span class="nav-text">Deep dive how to support Python UDF in Apache Flink 1.10</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Background"><span class="nav-number">2.</span> <span class="nav-text">Background</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Architecture-of-Python-UDFs-supports-in-Pyflink"><span class="nav-number">3.</span> <span class="nav-text">Architecture of Python UDFs supports in Pyflink</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Beam-on-Flink"><span class="nav-number">3.1.</span> <span class="nav-text">Beam on Flink</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Flink-on-Beam"><span class="nav-number">3.2.</span> <span class="nav-text">Flink on Beam</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Communication-between-JVM-and-Python-VM"><span class="nav-number">3.3.</span> <span class="nav-text">Communication between JVM and Python VM</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#How-to-use-PyFlink-with-UDFs-in-Apache-Flink-1-10"><span class="nav-number">4.</span> <span class="nav-text">How to use PyFlink with UDFs in Apache Flink 1.10</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Install-PyFlink"><span class="nav-number">4.1.</span> <span class="nav-text">Install PyFlink</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Define-a-Python-UDF"><span class="nav-number">4.2.</span> <span class="nav-text">Define a Python UDF</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Register-a-Python-UDF"><span class="nav-number">4.3.</span> <span class="nav-text">Register a Python UDF</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Python-UDF-dependency-management"><span class="nav-number">5.</span> <span class="nav-text">Python UDF dependency management</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Quick-start"><span class="nav-number">6.</span> <span class="nav-text">Quick start</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#More"><span class="nav-number">7.</span> <span class="nav-text">More</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Conclusion-amp-Upcoming-work"><span class="nav-number">8.</span> <span class="nav-text">Conclusion &amp; Upcoming work</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PyFlink-Want-You"><span class="nav-number">9.</span> <span class="nav-text">PyFlink Want You</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jincheng Sun</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.2.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="Total Visitors">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="Total Views">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/affix.js?v=7.2.0"></script>

  <script src="/js/schemes/pisces.js?v=7.2.0"></script>



  
  <script src="/js/scrollspy.js?v=7.2.0"></script>
<script src="/js/post-details.js?v=7.2.0"></script>



  


  <script src="/js/next-boot.js?v=7.2.0"></script>


  

  

  

  
  
<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://http-enjoyment-cool.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>


<script>
  var disqus_config = function() {
    this.page.url = "http://enjoyment.cool/2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/";
    this.page.identifier = "2020/02/19/Deep-dive-how-to-support-Python-UDF-in-Apache-Flink-1-10/";
    this.page.title = 'Deep dive how to support Python UDF in Apache Flink 1.10';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://http-enjoyment-cool.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    window.addEventListener('load', loadComments, false);
  
</script>





  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('3');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>


  

  

  

  

  

  

  

  

</body>
</html>
